# Story 1.2: Manual Transcript Upload Interface

## Status
Pending

## Story
**As a** coach,
**I want** to manually upload session transcripts through a web interface,
**so that** I can begin testing the AI summary generation with my actual coaching sessions.

## Acceptance Criteria
1. Simple web form for transcript text upload with session metadata (date, participants)
2. File upload capability supporting .txt and .docx transcript formats
3. Basic validation for transcript content and required session information
4. Participant name extraction and matching to create client records if needed
5. Successful upload confirmation with assigned session ID for tracking
6. Error handling for invalid files or missing required information

## Tasks / Subtasks

- [ ] **Task 1: Create Transcript Upload API Endpoints** (AC: 1, 3, 5, 6)
  - [ ] Create POST /api/v1/sessions/upload endpoint for transcript text submission
  - [ ] Create POST /api/v1/sessions/upload-file endpoint for file uploads (.txt, .docx)
  - [ ] Implement request validation using Pydantic schemas for session metadata
  - [ ] Add response schemas for successful upload confirmation with session ID
  - [ ] Implement comprehensive error handling with appropriate HTTP status codes
  - [ ] Add endpoint documentation with OpenAPI/Swagger integration

- [ ] **Task 2: Session Management Repository Layer** (AC: 1, 4, 5)
  - [ ] Create SessionRepository with create_session method
  - [ ] Create ClientRepository with find_or_create_client method
  - [ ] Create ClientSessionRepository with create_client_session method
  - [ ] Implement participant name extraction logic with configurable patterns
  - [ ] Add transaction management for atomic session creation workflow
  - [ ] Add database query optimization for client lookups

- [ ] **Task 3: File Processing Service** (AC: 2, 3, 6)
  - [ ] Create FileProcessingService for handling uploaded files
  - [ ] Implement .txt file reader with encoding detection
  - [ ] Implement .docx file reader using python-docx library
  - [ ] Add file size validation (max 10MB per transcript)
  - [ ] Add content validation (minimum transcript length, format checks)
  - [ ] Implement virus scanning integration placeholder for future security

- [ ] **Task 4: Participant Extraction and Client Management** (AC: 4)
  - [ ] Create ParticipantExtractor service for name identification
  - [ ] Implement regex patterns for common name formats in transcripts
  - [ ] Add fuzzy matching logic for existing client identification
  - [ ] Create client auto-creation workflow with extracted metadata
  - [ ] Add participant validation and deduplication logic
  - [ ] Implement participant role detection (coach vs client distinction)

- [ ] **Task 5: Frontend Upload Interface** (AC: 1, 2, 5, 6)
  - [ ] Create transcript upload page with form components
  - [ ] Implement drag-and-drop file upload interface
  - [ ] Add session metadata input fields (date, session type, notes)
  - [ ] Create upload progress indicator with real-time status
  - [ ] Implement client-side file validation before submission
  - [ ] Add success confirmation page with session details and next steps

- [ ] **Task 6: Testing and Quality Assurance** (All ACs)
  - [ ] Create unit tests for all API endpoints with various input scenarios
  - [ ] Create integration tests for file upload workflows
  - [ ] Add tests for participant extraction accuracy with sample transcripts
  - [ ] Create end-to-end tests for complete upload-to-confirmation flow
  - [ ] Add performance tests for large file uploads and processing
  - [ ] Create error scenario tests for all validation and error handling

## Dev Notes

### Previous Story Insights
**From Story 1.1:** Database schema is established with all required tables (sessions, clients, client_sessions, coaches, organizations). Coach entity exists for session association. Database connection and migration system is configured and ready for data operations.

### Data Models
**Primary Tables Used:** [Source: packages/api/src/models/core.py]
- **sessions**: id, coach_id, session_date, session_type, transcript_url, duration_minutes, participant_count, processing_status, session_metadata, created_at
- **clients**: id, name, email, organization_id, tags, engagement_score, created_at  
- **client_sessions**: id, client_id, session_id, speaking_time_seconds, engagement_level, breakthrough_detected, priority_score
- **coaches**: id, email, name, organization_id (for session association)

**Key Relationships:**
- Session.coach_id → Coach.id (one coach per session)
- ClientSession.session_id → Session.id (many clients per session)
- ClientSession.client_id → Client.id (track individual client participation)

### API Specifications
**Upload Endpoints:** [Source: Epic 1 AC Requirements]

**POST /api/v1/sessions/upload**
```json
Request Body:
{
  "transcript_text": "string (required, min_length=100)",
  "session_date": "2024-01-15 (required, ISO date format)",
  "session_type": "string (optional, e.g., 'individual', 'group', 'workshop')",
  "participants": ["John Doe", "Jane Smith"] (optional, extracted if not provided),
  "duration_minutes": "integer (optional)",
  "notes": "string (optional, additional session context)"
}

Response (201 Created):
{
  "session_id": "uuid",
  "status": "uploaded",
  "participants_identified": ["John Doe", "Jane Smith"],
  "clients_created": ["John Doe"],
  "clients_matched": ["Jane Smith"],
  "processing_status": "pending",
  "next_steps": "Session ready for AI analysis"
}
```

**POST /api/v1/sessions/upload-file**
```json
Request: multipart/form-data
- file: transcript file (.txt or .docx, max 10MB)
- session_date: date (required)
- session_type: string (optional)
- notes: string (optional)

Response: Same as text upload endpoint
```

**Error Responses:**
- 400 Bad Request: Invalid file format, missing required fields, content validation errors
- 413 Payload Too Large: File exceeds 10MB limit
- 422 Unprocessable Entity: Participant extraction failed, invalid session data
- 500 Internal Server Error: Database connection issues, file processing failures

### Component Specifications
**Technology Stack:** [Source: docs/backend-architecture.md#Tech Stack]
- FastAPI 0.109.0 with multipart file upload support
- python-docx 1.1.0 for .docx file processing
- chardet 5.2.0 for text encoding detection
- SQLAlchemy ORM for database operations
- Pydantic for request/response validation

**File Processing Requirements:**
- Maximum file size: 10MB per upload
- Supported formats: .txt (UTF-8, UTF-16, ASCII), .docx
- Content validation: Minimum 100 characters, maximum 1MB text content
- Participant extraction: Regex patterns for "Speaker:", "Coach:", "[Name]:", etc.

**Authentication Integration:** 
- For now: Temporary coach selection via dropdown or hardcoded test coach ID
- Future: JWT/OAuth2 authentication to identify coach automatically
- Coach selection validation to ensure valid coach_id for session creation

### File Locations
**API Service Additions:** [Source: packages/api/ structure]
```
packages/api/src/
├── routes/
│   ├── sessions.py              # New: Upload endpoints
│   └── __init__.py              # Update: Include sessions router
├── schemas/
│   ├── sessions.py              # New: Upload request/response schemas
│   ├── clients.py               # New: Client-related schemas
│   └── __init__.py              # Update: Export new schemas
├── repositories/
│   ├── sessions.py              # New: Session data access layer
│   ├── clients.py               # New: Client data access layer
│   └── __init__.py              # Update: Export repositories
├── services/
│   ├── __init__.py              # New: Services module
│   ├── file_processing.py       # New: File upload and processing
│   ├── participant_extraction.py # New: Name extraction logic
│   └── session_management.py    # New: Business logic orchestration
└── main.py                      # Update: Include sessions router
```

**Frontend Service:** [Source: packages/web/ structure]
```
packages/web/src/
├── pages/
│   └── upload/                  # New: Upload interface pages
│       ├── index.tsx            # Upload form page
│       └── success.tsx          # Upload confirmation page
├── components/
│   ├── upload/                  # New: Upload-specific components
│   │   ├── FileUploader.tsx     # Drag-drop file upload
│   │   ├── SessionForm.tsx      # Session metadata form
│   │   └── UploadProgress.tsx   # Progress indicator
│   └── common/                  # Shared UI components
├── services/
│   └── api.ts                   # Update: Add upload API calls
└── types/
    └── sessions.ts              # New: TypeScript interfaces
```

### Technical Constraints
**File Processing Limitations:** [Source: docs/backend-architecture.md#Security]
- Temporary file storage in /tmp with automatic cleanup
- File content scanning for malicious patterns before processing
- Memory-efficient streaming for large file uploads
- Concurrent upload limit per coach (5 simultaneous uploads)

**Database Considerations:**
- Use database transactions for atomic session+client creation
- Implement proper foreign key relationships for data integrity
- Add database indexes for efficient participant name lookups
- Consider transcript storage strategy (inline vs file system vs S3)

**Performance Requirements:**
- File upload processing time: < 30 seconds for files up to 10MB
- Participant extraction: < 5 seconds for typical session transcripts
- Database operations: < 2 seconds for session creation with multiple clients
- Concurrent uploads: Support 10 coaches uploading simultaneously

### Project Structure Notes
The implementation will extend the existing FastAPI structure from Story 1.1. All file paths follow the established monorepo pattern. The frontend component will be added to packages/web/ following React/Next.js conventions.

## Testing

### Testing Standards
[Source: docs/backend-architecture.md#Test Strategy and Standards]

**Test Framework:** pytest 8.0.0 with FastAPI TestClient
**Test Organization:** Tests in `tests/` directory mirroring source structure
**File Convention:** `test_[module_name].py`
**Location:** `tests/unit/` and `tests/integration/` within packages/api
**Coverage Requirement:** 80% overall, 90% for business logic

**Testing Requirements for this Story:**

**Unit Tests (tests/unit/):**
- `test_sessions_routes.py`: API endpoint validation, request/response handling
- `test_file_processing.py`: File reading, validation, format support
- `test_participant_extraction.py`: Name extraction accuracy with various formats
- `test_session_repository.py`: Database operations, transaction handling
- `test_client_repository.py`: Client matching, creation, deduplication

**Integration Tests (tests/integration/):**
- `test_upload_workflow.py`: End-to-end upload process from file to database
- `test_file_upload_api.py`: Complete API workflow with real file uploads
- `test_participant_matching.py`: Database integration for client matching
- `test_error_scenarios.py`: Error handling across all components

**Test Data Requirements:**
- Sample transcript files (.txt, .docx) with various participant formats
- Test coach and client records in test database
- Mock file upload scenarios with different edge cases
- Error scenario test data (malformed files, invalid metadata)

**Frontend Testing (packages/web/):**
- Component unit tests using Jest and React Testing Library
- File upload component testing with mock file objects
- Form validation testing for session metadata
- Integration tests for API communication

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|---------|
| 2025-08-17 | 1.0 | Initial story creation based on Epic 1 specifications | Bob (Scrum Master) |

## Dev Agent Record

### Agent Model Used
Sonnet 4 (claude-sonnet-4-20250514)

### Debug Log References  
No debugging issues anticipated for initial creation.

### Completion Notes List
- ⏸️ Story created and ready for development
- ⏸️ Detailed task breakdown following Epic 1 acceptance criteria exactly
- ⏸️ Technical specifications aligned with existing project architecture
- ⏸️ Database schema from Story 1.1 leveraged for session and client management
- ⏸️ API patterns consistent with FastAPI structure from Story 1.1
- ⏸️ Testing framework extends existing pytest configuration

### File List
**Files to be Created:**
- packages/api/src/routes/sessions.py (upload endpoints)
- packages/api/src/schemas/sessions.py (upload request/response schemas)
- packages/api/src/schemas/clients.py (client-related schemas)
- packages/api/src/repositories/sessions.py (session data access)
- packages/api/src/repositories/clients.py (client data access)
- packages/api/src/services/__init__.py (services module)
- packages/api/src/services/file_processing.py (file upload handling)
- packages/api/src/services/participant_extraction.py (name extraction)
- packages/api/src/services/session_management.py (business logic)
- packages/web/src/pages/upload/index.tsx (upload form)
- packages/web/src/pages/upload/success.tsx (confirmation page)
- packages/web/src/components/upload/FileUploader.tsx (file upload component)
- packages/web/src/components/upload/SessionForm.tsx (metadata form)
- packages/web/src/components/upload/UploadProgress.tsx (progress indicator)
- packages/web/src/types/sessions.ts (TypeScript interfaces)

**Files to be Updated:**
- packages/api/src/main.py (include sessions router)
- packages/api/src/routes/__init__.py (export sessions router)
- packages/api/src/schemas/__init__.py (export new schemas)
- packages/api/src/repositories/__init__.py (export repositories)
- packages/api/requirements.txt (add python-docx, chardet dependencies)
- packages/web/src/services/api.ts (add upload API calls)

**Test Files to be Created:**
- packages/api/tests/unit/test_sessions_routes.py
- packages/api/tests/unit/test_file_processing.py
- packages/api/tests/unit/test_participant_extraction.py
- packages/api/tests/unit/test_session_repository.py
- packages/api/tests/unit/test_client_repository.py
- packages/api/tests/integration/test_upload_workflow.py
- packages/api/tests/integration/test_file_upload_api.py
- packages/api/tests/integration/test_participant_matching.py
- packages/api/tests/integration/test_error_scenarios.py
- packages/web/src/components/upload/__tests__/ (React component tests)

## QA Results

### Review Date: Pending

### Reviewed By: Pending

### Code Quality Assessment
Pending implementation.

### Refactoring Performed
None - initial story creation.

### Compliance Check
- Coding Standards: ✓ Specification follows FastAPI and React best practices
- Project Structure: ✓ Aligns with architecture specifications in docs/backend-architecture.md
- Testing Strategy: ✓ Comprehensive unit and integration test plan
- All ACs Met: ✓ All 6 acceptance criteria from Epic 1 addressed in task breakdown

### Improvements Checklist
- [ ] Implementation pending

### Security Review
**Security Considerations Planned:**
- File upload validation and size limits (10MB max)
- Content scanning for malicious patterns
- Temporary file cleanup after processing
- Input validation for all session metadata
- SQL injection prevention through SQLAlchemy ORM
- File type validation beyond extension checking

**Authentication Note:**
- Temporary coach selection approach for this story
- No user authentication required initially
- Future JWT/OAuth2 integration planned for coach identification

### Performance Considerations
**Performance Optimizations Planned:**
- Streaming file uploads for memory efficiency
- Database transaction optimization for session creation
- Participant extraction with regex optimization
- Concurrent upload handling with rate limiting
- Database indexing for efficient client lookups

### Final Status
⏸️ **Ready for Development**

Story specification complete with comprehensive technical details, task breakdown, and testing requirements. Implementation can begin following the defined architecture and acceptance criteria.